<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CiberTech - Gerenciar Produtos</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>
<body>

<header>
    <!-- ... (cabeçalho idêntico) ... -->
    <div class="container topbar">
      <div class="brand">
        <div class="logo">CT</div>
        <div>
          <a href="index.html"><button class="icon-btn" style="font-weight:800;">CiberTech</button></a>
          <div style="font-size:12px;color:var(--muted)">Hardware • Periféricos • Promoções</div>
        </div>
      </div>
      <div class="search" role="search">
        <input type="search" id="main-search" placeholder="Procure por produtos..." aria-label="buscar produto" />
        <button id="search-btn" aria-label="Pesquisar">Buscar</button>
      </div>
      <div class="actions">
        <!-- Populado por js/header.js -->
      </div>
    </div>
   <div class="container" style="padding-bottom:10px">
      <nav style="display:flex;gap:12px;align-items:center" id="category-nav">
        <!-- ... links ... -->
      </nav>
    </div>
</header>

<main class="container" style="margin-top: 48px; max-width: 800px;">
  <div style="margin-bottom: 32px;">
    <h1 style="margin: 0 0 8px 0;">Gerenciar Produtos</h1>
    <p style="color: var(--muted); margin: 0;">Adicione ou edite produtos da loja</p>
  </div>

  <div id="access-denied" style="display: none; text-align: center; padding: 60px 0;">
    <h2 style="color: var(--muted);">⚠️ Acesso Negado</h2>
    <p style="color: var(--muted); margin-bottom: 24px;">Apenas administradores podem acessar esta página.</p>
    <a href="index.html"><button class="cta">Voltar para Home</button></a>
  </div>

  <!-- Modal de Edição (sem alterações) -->
  <div id="edit-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1000; overflow-y: auto; padding: 20px;">
    <div style="max-width: 800px; margin: 40px auto; background: var(--bg); border-radius: 12px; border: 1px solid var(--border-color); padding: 32px; position: relative;">
      <button onclick="closeEditModal()" style="position: absolute; top: 16px; right: 16px; background: transparent; border: 0; color: var(--muted); font-size: 24px; cursor: pointer; padding: 8px;">&times;</button>
      <h2 style="margin: 0 0 24px 0;">Editar Produto</h2>
      <form id="edit-product-form">
        <!-- ... (campos do formulário de edição, que já estavam corretos) ... -->
        <input type="hidden" id="edit-produto-id" name="produto_id">
        
        <div style="margin-bottom: 16px;">
          <label for="edit-nome" style="display: block; margin-bottom: 8px; font-weight: 600;">Nome do Produto *</label>
          <input type="text" id="edit-nome" name="nome" required style="width: 100%; padding: 12px; border-radius: 8px; border: 0; background: #0b1020; color: #e6eef8;">
        </div>

        <div style="margin-bottom: 16px;">
          <label for="edit-categoria" style="display: block; margin-bottom: 8px; font-weight: 600;">Categoria ID *</label>
          <select id="edit-categoria" name="categoria_id" required
                  style="width: 100%; padding: 12px; border-radius: 8px; border: 0; background: #0b1020; color: #e6eef8;">
            <option value="">Selecione uma categoria</option>
            <option value="5">Placas de Vídeo</option>
            <option value="6">Processadores</option>
            <option value="7">Placas-mãe</option>
            <option value="8">Memória RAM</option>
            <option value="13">SSD</option>
            <option value="14">HD</option>
            <option value="3">Monitores</option>
            <option value="2">Periféricos (Geral)</option>
            <option value="10">Teclados</option>
            <option value="11">Mouses</option>
            <option value="12">Headsets</option>
          </select>
        </div>
        <!-- ... (restante do formulário de edição) ... -->
        <div style="display: flex; gap: 12px; margin-top: 24px;">
          <button type="submit" class="cta" style="flex: 1;">Salvar Alterações</button>
          <button type="button" onclick="closeEditModal()" class="buy" style="flex: 1; background: #334155; color: white;">Cancelar</button>
        </div>
      </form>
    </div>
  </div>

  <div id="admin-content" style="display: none;">
    <div style="background: var(--card-bg); padding: 32px; border-radius: 12px; border: 1px solid var(--border-color);">
      <h2 style="margin: 0 0 24px 0;">Adicionar Novo Produto</h2>
      
      <form id="product-form">
        <div style="margin-bottom: 16px;">
          <label for="nome" style="display: block; margin-bottom: 8px; font-weight: 600;">Nome do Produto *</label>
          <input type="text" id="nome" name="nome" required 
                 style="width: 100%; padding: 12px; border-radius: 8px; border: 0; background: #0b1020; color: #e6eef8;">
        </div>

        <!-- ** SEÇÃO DE CATEGORIA CORRIGIDA ** -->
        <div style="margin-bottom: 16px;">
          <label for="categoria" style="display: block; margin-bottom: 8px; font-weight: 600;">Categoria ID *</label>
          <select id="categoria" name="categoria_id" required
                  style="width: 100%; padding: 12px; border-radius: 8px; border: 0; background: #0b1020; color: #e6eef8;">
            <option value="">Selecione uma categoria</option>
            <option value="5">Placas de Vídeo (5)</option>
            <option value="6">Processadores (6)</option>
            <option value="7">Placas-mãe (7)</option>
            <option value="8">Memória RAM (8)</option>
            <option value="13">SSD (13)</option>
            <option value="14">HD (14)</option>
            <option value="3">Monitores (3)</option>
            <option value="2">Periféricos (Geral) (2)</option>
            <option value="10">Teclados (10)</option>
            <option value="11">Mouses (11)</option>
            <option value="12">Headsets (12)</option>
          </select>
          <small style="color: var(--muted);">Nota: Popule esta lista dinamicamente com a API `php/categories.php` no futuro.</small>
        </div>
        <!-- ** FIM DA CORREÇÃO ** -->

        <div style="margin-bottom: 16px;">
          <label for="fabricante" style="display: block; margin-bottom: 8px; font-weight: 600;">Fabricante *</label>
          <input type="text" id="fabricante" name="fabricante" required placeholder="Ex: NVIDIA, AMD, Intel"
                 style="width: 100%; padding: 12px; border-radius: 8px; border: 0; background: #0b1020; color: #e6eef8;">
        </div>

        <div style="margin-bottom: 16px;">
          <label for="descricao" style="display: block; margin-bottom: 8px; font-weight: 600;">Descrição *</label>
          <textarea id="descricao" name="descricao" rows="3" required
                    style="width: 100%; padding: 12px; border-radius: 8px; border: 0; background: #0b1020; color: #e6eef8; resize: vertical;"></textarea>
        </div>

        <div style="margin-bottom: 16px;">
          <label for="especificacoes" style="display: block; margin-bottom: 8px; font-weight: 600;">Especificações *</label>
          <textarea id="especificacoes" name="especificacoes" rows="4" required placeholder="Ex: GPU: AD102 | 24GB GDDR6X | 384-bit"
                    style="width: 100%; padding: 12px; border-radius: 8px; border: 0; background: #0b1020; color: #e6eef8; resize: vertical;"></textarea>
        </div>

        <div style="margin-bottom: 16px;">
          <label for="sku" style="display: block; margin-bottom: 8px; font-weight: 600;">SKU (Código Único) *</label>
          <input type="text" id="sku" name="sku" required placeholder="Ex: GPU-RTX4090-24GB"
                 style="width: 100%; padding: 12px; border-radius: 8px; border: 0; background: #0b1020; color: #e6eef8;">
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
          <div>
            <label for="preco" style="display: block; margin-bottom: 8px; font-weight: 600;">Preço (R$) *</label>
            <input type="number" id="preco" name="preco" step="0.01" min="0" required
                   style="width: 100%; padding: 12px; border-radius: 8px; border: 0; background: #0b1020; color: #e6eef8;">
          </div>
          <div>
            <label for="estoque" style="display: block; margin-bottom: 8px; font-weight: 600;">Estoque *</label>
            <input type="number" id="estoque" name="estoque" min="0" value="0" required
                   style="width: 100%; padding: 12px; border-radius: 8px; border: 0; background: #0b1020; color: #e6eef8;">
          </div>
        </div>

        <div style="margin-bottom: 16px;">
          <label for="fornecedor" style="display: block; margin-bottom: 8px; font-weight: 600;">Fornecedor ID</label>
          <input type="number" id="fornecedor" name="fornecedor_id" min="1" value="1"
                 style="width: 100%; padding: 12px; border-radius: 8px; border: 0; background: #0b1020; color: #e6eef8;">
          <small style="color: var(--muted);">1=TechDistribuidora, 2=HardwareMax, 3=PerifericosBR (Popule dinamicamente no futuro)</small>
        </div>

        <div style="margin-bottom: 24px;">
          <label for="imagem" style="display: block; margin-bottom: 8px; font-weight: 600;">URL da Imagem</label>
          <input type="url" id="imagem" name="imagem" placeholder="https://exemplo.com/imagem.jpg"
                 style="width: 100%; padding: 12px; border-radius: 8px; border: 0; background: #0b1020; color: #e6eef8;">
        </div>

        <button type="submit" class="cta" style="width: 100%;">Adicionar Produto</button>
      </form>
    </div>

    <div style="margin-top: 32px;">
      <h2 style="margin: 0 0 16px 0;">Produtos Cadastrados</h2>
      <div id="products-list" style="display: grid; gap: 16px;">
        <p style="text-align: center; color: var(--muted); padding: 20px;">Carregando produtos...</p>
      </div>
    </div>
  </div>
</main>

<footer style="margin-top:48px">
    <!-- ... (rodapé idêntico) ... -->
</footer>

<script src="js/header.js"></script>
<script>
  // ** CORREÇÃO DE SEGURANÇA: Usar textContent para evitar XSS **
  function safeText(text) {
      const el = document.createElement('div');
      el.textContent = text;
      return el.innerHTML;
  }

  // Verifica se o usuário é admin
  async function checkAdminAccess() {
    try {
      const res = await fetch('php/auth.php');
      const data = await res.json();
      
      if (!data.success || !data.user || !data.user.is_admin) {
        document.getElementById('access-denied').style.display = 'block';
        return false;
      }
      
      document.getElementById('admin-content').style.display = 'block';
      loadProducts();
      return true;
      
    } catch (err) {
      console.error('Erro ao verificar acesso:', err);
      document.getElementById('access-denied').style.display = 'block';
      return false;
    }
  }

  // Carrega lista de produtos
  async function loadProducts() {
    try {
      const res = await fetch('php/products.php?limit=100');
      const data = await res.json();
      
      if (!data.success || !data.products || data.products.length === 0) {
        document.getElementById('products-list').innerHTML = 
          '<p style="text-align: center; color: var(--muted); padding: 20px;">Nenhum produto cadastrado.</p>';
        return;
      }
      
      renderProducts(data.products);
      
    } catch (err) {
      console.error('Erro ao carregar produtos:', err);
    }
  }

  // Renderiza lista de produtos (com correção de segurança)
  function renderProducts(products) {
    const container = document.getElementById('products-list');
    
    container.innerHTML = products.map(p => `
      <div style="background: var(--card-bg); padding: 20px; border-radius: 12px; border: 1px solid var(--border-color); display: flex; gap: 16px; flex-wrap: wrap;">
        <img src="${safeText(p.imagem || 'https://via.placeholder.com/80')}" 
             alt="${safeText(p.nome)}"
             style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px; background: #0b1020;">
        <div style="flex: 1; min-width: 250px;">
          <h3 style="margin: 0 0 4px 0; word-break: break-word;">${safeText(p.nome)}</h3>
          <p style="margin: 0 0 4px 0; color: var(--muted); font-size: 14px;">${safeText(p.fabricante || 'Sem fabricante')} • SKU: ${safeText(p.sku || 'N/A')}</p>
          <p style="margin: 0; color: var(--primary); font-weight: 700;">R$ ${safeText(parseFloat(p.preco).toFixed(2).replace('.', ','))}</p>
          <p style="margin: 4px 0 0 0; color: var(--muted); font-size: 13px;">Estoque: ${safeText(p.estoque)} unidades • Categoria: ${safeText(p.categoria_nome || 'N/A')}</p>
        </div>
        <div style="display: flex; flex-direction: column; gap: 8px; min-width: 100px;">
          <button onclick="openEditModal(${p.produto_id})" 
                  style="padding: 8px 16px; background: var(--primary); color: white; border: 0; border-radius: 6px; cursor: pointer; font-weight: 600;">
            Editar
          </button>
          <button onclick="deleteProduct(${p.produto_id})" 
                  style="padding: 8px 16px; background: #ef4444; color: white; border: 0; border-radius: 6px; cursor: pointer; font-weight: 600;">
            Excluir
          </button>
        </div>
      </div>
    `).join('');
  }

  // Adiciona produto
  async function handleSubmit(e) {
    e.preventDefault();
    
    const form = e.target;
    const submitBtn = form.querySelector('button[type="submit"]');
    
    submitBtn.disabled = true;
    submitBtn.textContent = 'Salvando...';
    
    try {
      const formData = {
        nome: form.nome.value,
        categoria_id: parseInt(form.categoria_id.value),
        fabricante: form.fabricante.value,
        descricao: form.descricao.value,
        especificacoes: form.especificacoes.value,
        sku: form.sku.value,
        preco: parseFloat(form.preco.value),
        estoque: parseInt(form.estoque.value) || 0,
        fornecedor_id: parseInt(form.fornecedor_id.value) || 1,
        imagem: form.imagem.value
      };
      
      const res = await fetch('php/admin_products.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(formData)
      });
      
      const data = await res.json();
      
      if (!data.success) {
        alert(data.error || 'Erro ao adicionar produto');
        return;
      }
      
      alert('Produto adicionado com sucesso!');
      form.reset();
      loadProducts();
      
    } catch (err) {
      console.error('Erro:', err);
      alert('Erro ao adicionar produto. Tente novamente.');
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = 'Adicionar Produto';
    }
  }

  // Abre modal de edição
  async function openEditModal(produtoId) {
    try {
      const res = await fetch(`php/product.php?id=${produtoId}`);
      const data = await res.json();
      
      if (!data.success || !data.product) {
        alert('Erro ao carregar produto');
        return;
      }
      
      const p = data.product;
      
      document.getElementById('edit-produto-id').value = p.produto_id;
      document.getElementById('edit-nome').value = p.nome;
      document.getElementById('edit-categoria').value = p.categoria_id;
      document.getElementById('edit-fabricante').value = p.fabricante || '';
      document.getElementById('edit-descricao').value = p.descricao || '';
      document.getElementById('edit-especificacoes').value = p.especificacoes || '';
      document.getElementById('edit-sku').value = p.sku || '';
      document.getElementById('edit-preco').value = p.preco;
      document.getElementById('edit-estoque').value = p.estoque;
      document.getElementById('edit-fornecedor').value = p.fornecedor_id || 1;
      document.getElementById('edit-imagem').value = p.imagem || '';
      
      document.getElementById('edit-modal').style.display = 'block';
      document.body.style.overflow = 'hidden';
      
    } catch (err) {
      console.error('Erro:', err);
      alert('Erro ao abrir edição. Tente novamente.');
    }
  }

  // Fecha modal de edição
  function closeEditModal() {
    document.getElementById('edit-modal').style.display = 'none';
    document.body.style.overflow = 'auto';
    document.getElementById('edit-product-form').reset();
  }

  // Salva edição do produto
  async function handleEditSubmit(e) {
    e.preventDefault();
    
    const form = e.target;
    const submitBtn = form.querySelector('button[type="submit"]');
    
    submitBtn.disabled = true;
    submitBtn.textContent = 'Salvando...';
    
    try {
      const formData = {
        produto_id: parseInt(form.produto_id.value),
        nome: form.nome.value,
        categoria_id: parseInt(form.categoria_id.value),
        fabricante: form.fabricante.value,
        descricao: form.descricao.value,
        especificacoes: form.especificacoes.value,
        sku: form.sku.value,
        preco: parseFloat(form.preco.value),
        estoque: parseInt(form.estoque.value),
        fornecedor_id: parseInt(form.fornecedor_id.value) || 1,
        imagem: form.imagem.value
      };
      
      const res = await fetch('php/admin_products.php', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(formData)
      });
      
      const data = await res.json();
      
      if (!data.success) {
        alert(data.error || 'Erro ao atualizar produto');
        return;
      }
      
      alert('Produto atualizado com sucesso!');
      closeEditModal();
      loadProducts();
      
    } catch (err) {
      console.error('Erro:', err);
      alert('Erro ao atualizar produto. Tente novamente.');
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = 'Salvar Alterações';
    }
  }

  // Deleta produto
  async function deleteProduct(produtoId) {
    // ** Correção: Substituir confirm() por uma UI não-bloqueante se possível **
    // Por enquanto, mantemos o confirm() mas cientes da limitação.
    if (!confirm('Tem certeza que deseja excluir este produto?')) {
      return;
    }
    
    try {
      const res = await fetch('php/admin_products.php', {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ produto_id: produtoId })
      });
      
      const data = await res.json();
      
      if (!data.success) {
        alert(data.error || 'Erro ao excluir produto');
        return;
      }
      
      alert('Produto excluído com sucesso!');
      loadProducts();
      
    } catch (err) {
      console.error('Erro:', err);
      alert('Erro ao excluir produto. Tente novamente.');
    }
  }

  // Event listeners
  document.getElementById('product-form').addEventListener('submit', handleSubmit);
  document.getElementById('edit-product-form').addEventListener('submit', handleEditSubmit);
  
  document.getElementById('edit-modal').addEventListener('click', (e) => {
    if (e.target.id === 'edit-modal') {
      closeEditModal();
    }
  });
  
  document.addEventListener('DOMContentLoaded', checkAdminAccess);
</script>

</body>
</html>