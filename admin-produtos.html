<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CiberTech - Gerenciar Produtos</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>
<body>

<header>
    <div class="container topbar">
      <div class="brand">
        <div class="logo">CT</div>
        <div>
          <a href="index.html"><button class="icon-btn" style="font-weight:800;">CiberTech</button></a>
          <div style="font-size:12px;color:var(--muted)">Hardware ‚Ä¢ Perif√©ricos ‚Ä¢ Promo√ß√µes</div>
        </div>
      </div>

      <div class="search" role="search" aria-label="Busca de produtos">
        <input type="search" placeholder="Procure por placa, fonte, gabinete, monitor..." aria-label="buscar produto" />
        <button aria-label="Pesquisar">Buscar</button>
      </div>

      <div class="actions">
        <a href="carrinho.html"><button class="icon-btn" aria-label="Carrinho">üõí Carrinho</button></a>
        <a href="pedidos.html"><button class="icon-btn" aria-label="Pedidos">üì¶ Pedidos</button></a>
        <a href="admin-produtos.html"><button class="icon-btn" aria-label="Admin" style="color: var(--primary);">‚öôÔ∏è Admin</button></a>
        <a href="#"><button class="icon-btn" aria-label="Perfil">üë§</button></a>
      </div>
    </div>

   <div class="container" style="padding-bottom:10px">
      <nav style="display:flex;gap:12px;align-items:center">
        <a href="#">Placas-m√£e</a>
        <a href="#">Processadores</a>
        <a href="#">Placas de v√≠deo</a>
        <a href="#">Mem√≥ria RAM</a>
        <a href="#">SSD / HD</a>
        <a href="#">Fontes</a>
        <a href="#">Monitores</a>
        <a href="#">Perif√©ricos</a>
      </nav>
    </div>
  </header>

<main class="container" style="margin-top: 48px; max-width: 800px;">
  <div style="margin-bottom: 32px;">
    <h1 style="margin: 0 0 8px 0;">Gerenciar Produtos</h1>
    <p style="color: var(--muted); margin: 0;">Adicione ou edite produtos da loja</p>
  </div>

  <div id="access-denied" style="display: none; text-align: center; padding: 60px 0;">
    <h2 style="color: var(--muted);">‚ö†Ô∏è Acesso Negado</h2>
    <p style="color: var(--muted); margin-bottom: 24px;">Apenas administradores podem acessar esta p√°gina.</p>
    <a href="index.html"><button class="cta">Voltar para Home</button></a>
  </div>

  <!-- Modal de Edi√ß√£o -->
  <div id="edit-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1000; overflow-y: auto; padding: 20px;">
    <div style="max-width: 800px; margin: 40px auto; background: var(--bg); border-radius: 12px; border: 1px solid var(--border-color); padding: 32px; position: relative;">
      <button onclick="closeEditModal()" style="position: absolute; top: 16px; right: 16px; background: transparent; border: 0; color: var(--muted); font-size: 24px; cursor: pointer; padding: 8px;">&times;</button>
      
      <h2 style="margin: 0 0 24px 0;">Editar Produto</h2>
      
      <form id="edit-product-form">
        <input type="hidden" id="edit-produto-id" name="produto_id">
        
        <div style="margin-bottom: 16px;">
          <label for="edit-nome" style="display: block; margin-bottom: 8px; font-weight: 600;">Nome do Produto *</label>
          <input type="text" id="edit-nome" name="nome" required 
                 style="width: 100%; padding: 12px; border-radius: 8px; border: 0; background: #0b1020; color: #e6eef8;">
        </div>

        <div style="margin-bottom: 16px;">
          <label for="edit-categoria" style="display: block; margin-bottom: 8px; font-weight: 600;">Categoria ID *</label>
          <select id="edit-categoria" name="categoria_id" required
                  style="width: 100%; padding: 12px; border-radius: 8px; border: 0; background: #0b1020; color: #e6eef8;">
            <option value="">Selecione uma categoria</option>
            <option value="5">Placas de V√≠deo</option>
            <option value="6">Processadores</option>
            <option value="7">Placas-m√£e</option>
            <option value="8">Mem√≥ria RAM</option>
            <option value="13">SSD</option>
            <option value="14">HD</option>
            <option value="3">Monitores</option>
            <option value="2">Perif√©ricos</option>
            <option value="10">Teclados</option>
            <option value="11">Mouses</option>
            <option value="12">Headsets</option>
          </select>
        </div>

        <div style="margin-bottom: 16px;">
          <label for="edit-fabricante" style="display: block; margin-bottom: 8px; font-weight: 600;">Fabricante *</label>
          <input type="text" id="edit-fabricante" name="fabricante" required
                 style="width: 100%; padding: 12px; border-radius: 8px; border: 0; background: #0b1020; color: #e6eef8;">
        </div>

        <div style="margin-bottom: 16px;">
          <label for="edit-descricao" style="display: block; margin-bottom: 8px; font-weight: 600;">Descri√ß√£o *</label>
          <textarea id="edit-descricao" name="descricao" rows="3" required
                    style="width: 100%; padding: 12px; border-radius: 8px; border: 0; background: #0b1020; color: #e6eef8; resize: vertical;"></textarea>
        </div>

        <div style="margin-bottom: 16px;">
          <label for="edit-especificacoes" style="display: block; margin-bottom: 8px; font-weight: 600;">Especifica√ß√µes *</label>
          <textarea id="edit-especificacoes" name="especificacoes" rows="4" required
                    style="width: 100%; padding: 12px; border-radius: 8px; border: 0; background: #0b1020; color: #e6eef8; resize: vertical;"></textarea>
        </div>

        <div style="margin-bottom: 16px;">
          <label for="edit-sku" style="display: block; margin-bottom: 8px; font-weight: 600;">SKU *</label>
          <input type="text" id="edit-sku" name="sku" required
                 style="width: 100%; padding: 12px; border-radius: 8px; border: 0; background: #0b1020; color: #e6eef8;">
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
          <div>
            <label for="edit-preco" style="display: block; margin-bottom: 8px; font-weight: 600;">Pre√ßo (R$) *</label>
            <input type="number" id="edit-preco" name="preco" step="0.01" min="0" required
                   style="width: 100%; padding: 12px; border-radius: 8px; border: 0; background: #0b1020; color: #e6eef8;">
          </div>
          <div>
            <label for="edit-estoque" style="display: block; margin-bottom: 8px; font-weight: 600;">Estoque *</label>
            <input type="number" id="edit-estoque" name="estoque" min="0" required
                   style="width: 100%; padding: 12px; border-radius: 8px; border: 0; background: #0b1020; color: #e6eef8;">
          </div>
        </div>

        <div style="margin-bottom: 16px;">
          <label for="edit-fornecedor" style="display: block; margin-bottom: 8px; font-weight: 600;">Fornecedor ID</label>
          <input type="number" id="edit-fornecedor" name="fornecedor_id" min="1" value="1"
                 style="width: 100%; padding: 12px; border-radius: 8px; border: 0; background: #0b1020; color: #e6eef8;">
        </div>

        <div style="margin-bottom: 24px;">
          <label for="edit-imagem" style="display: block; margin-bottom: 8px; font-weight: 600;">URL da Imagem</label>
          <input type="url" id="edit-imagem" name="imagem" placeholder="https://exemplo.com/imagem.jpg"
                 style="width: 100%; padding: 12px; border-radius: 8px; border: 0; background: #0b1020; color: #e6eef8;">
        </div>

        <div style="display: flex; gap: 12px;">
          <button type="submit" class="cta" style="flex: 1;">Salvar Altera√ß√µes</button>
          <button type="button" onclick="closeEditModal()" class="buy" style="flex: 1;">Cancelar</button>
        </div>
      </form>
    </div>
  </div>

  <div id="admin-content" style="display: none;">
    <div style="background: var(--card-bg); padding: 32px; border-radius: 12px; border: 1px solid var(--border-color);">
      <h2 style="margin: 0 0 24px 0;">Adicionar Novo Produto</h2>
      
      <form id="product-form">
        <div style="margin-bottom: 16px;">
          <label for="nome" style="display: block; margin-bottom: 8px; font-weight: 600;">Nome do Produto *</label>
          <input type="text" id="nome" name="nome" required 
                 style="width: 100%; padding: 12px; border-radius: 8px; border: 0; background: #0b1020; color: #e6eef8;">
        </div>

        <div style="margin-bottom: 16px;">
          <label for="categoria" style="display: block; margin-bottom: 8px; font-weight: 600;">Categoria ID *</label>
          <select id="categoria" name="categoria_id" required
                  style="width: 100%; padding: 12px; border-radius: 8px; border: 0; background: #0b1020; color: #e6eef8;">
            <option value="">Selecione uma categoria</option>
            <option value="5">Placas de V√≠deo</option>
            <option value="6">Processadores</option>
            <option value="7">Placas-m√£e</option>
            <option value="8">Mem√≥ria RAM</option>
            <option value="13">SSD</option>
            <option value="14">HD</option>
            <option value="3">Monitores</option>
            <option value="2">Perif√©ricos</option>
            <option value="10">Teclados</option>
            <option value="11">Mouses</option>
            <option value="12">Headsets</option>
          </select>
        </div>

        <div style="margin-bottom: 16px;">
          <label for="fabricante" style="display: block; margin-bottom: 8px; font-weight: 600;">Fabricante *</label>
          <input type="text" id="fabricante" name="fabricante" required placeholder="Ex: NVIDIA, AMD, Intel"
                 style="width: 100%; padding: 12px; border-radius: 8px; border: 0; background: #0b1020; color: #e6eef8;">
        </div>

        <div style="margin-bottom: 16px;">
          <label for="descricao" style="display: block; margin-bottom: 8px; font-weight: 600;">Descri√ß√£o *</label>
          <textarea id="descricao" name="descricao" rows="3" required
                    style="width: 100%; padding: 12px; border-radius: 8px; border: 0; background: #0b1020; color: #e6eef8; resize: vertical;"></textarea>
        </div>

        <div style="margin-bottom: 16px;">
          <label for="especificacoes" style="display: block; margin-bottom: 8px; font-weight: 600;">Especifica√ß√µes *</label>
          <textarea id="especificacoes" name="especificacoes" rows="4" required placeholder="Ex: GPU: AD102 | 24GB GDDR6X | 384-bit"
                    style="width: 100%; padding: 12px; border-radius: 8px; border: 0; background: #0b1020; color: #e6eef8; resize: vertical;"></textarea>
        </div>

        <div style="margin-bottom: 16px;">
          <label for="sku" style="display: block; margin-bottom: 8px; font-weight: 600;">SKU (C√≥digo √önico) *</label>
          <input type="text" id="sku" name="sku" required placeholder="Ex: GPU-RTX4090-24GB"
                 style="width: 100%; padding: 12px; border-radius: 8px; border: 0; background: #0b1020; color: #e6eef8;">
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
          <div>
            <label for="preco" style="display: block; margin-bottom: 8px; font-weight: 600;">Pre√ßo (R$) *</label>
            <input type="number" id="preco" name="preco" step="0.01" min="0" required
                   style="width: 100%; padding: 12px; border-radius: 8px; border: 0; background: #0b1020; color: #e6eef8;">
          </div>
          <div>
            <label for="estoque" style="display: block; margin-bottom: 8px; font-weight: 600;">Estoque *</label>
            <input type="number" id="estoque" name="estoque" min="0" value="0" required
                   style="width: 100%; padding: 12px; border-radius: 8px; border: 0; background: #0b1020; color: #e6eef8;">
          </div>
        </div>

        <div style="margin-bottom: 16px;">
          <label for="fornecedor" style="display: block; margin-bottom: 8px; font-weight: 600;">Fornecedor ID</label>
          <input type="number" id="fornecedor" name="fornecedor_id" min="1" value="1"
                 style="width: 100%; padding: 12px; border-radius: 8px; border: 0; background: #0b1020; color: #e6eef8;">
          <small style="color: var(--muted);">1=TechDistribuidora, 2=HardwareMax, 3=PerifericosBR</small>
        </div>

        <div style="margin-bottom: 24px;">
          <label for="imagem" style="display: block; margin-bottom: 8px; font-weight: 600;">URL da Imagem</label>
          <input type="url" id="imagem" name="imagem" placeholder="https://exemplo.com/imagem.jpg"
                 style="width: 100%; padding: 12px; border-radius: 8px; border: 0; background: #0b1020; color: #e6eef8;">
        </div>

        <button type="submit" class="cta" style="width: 100%;">Adicionar Produto</button>
      </form>
    </div>

    <div style="margin-top: 32px;">
      <h2 style="margin: 0 0 16px 0;">Produtos Cadastrados</h2>
      <div id="products-list" style="display: grid; gap: 16px;">
        <p style="text-align: center; color: var(--muted); padding: 20px;">Carregando produtos...</p>
      </div>
    </div>
  </div>
</main>

<footer style="margin-top:48px">
    <div class="container">
      <div class="footer-content">
        <div class="footer-left">
          <div style="font-weight:800">CiberTech</div>
          <div style="color:var(--muted)">¬© 2025 ‚Ä¢ Todos os direitos reservados</div>
        </div>
        <div class="footer-right" style="color:var(--muted)">Pagamento seguro ‚Ä¢ Parcelamos em at√© 12x</div>
      </div>
    </div>
</footer>

<script src="js/header.js"></script>
<script>
  // Verifica se o usu√°rio √© admin
  async function checkAdminAccess() {
    try {
      const res = await fetch('php/auth.php');
      const data = await res.json();
      
      if (!data.success || !data.user || !data.user.is_admin) {
        document.getElementById('access-denied').style.display = 'block';
        return false;
      }
      
      document.getElementById('admin-content').style.display = 'block';
      loadProducts();
      return true;
      
    } catch (err) {
      console.error('Erro ao verificar acesso:', err);
      document.getElementById('access-denied').style.display = 'block';
      return false;
    }
  }

  // Carrega lista de produtos
  async function loadProducts() {
    try {
      const res = await fetch('php/products.php?limit=100');
      const data = await res.json();
      
      if (!data.success || !data.products || data.products.length === 0) {
        document.getElementById('products-list').innerHTML = 
          '<p style="text-align: center; color: var(--muted); padding: 20px;">Nenhum produto cadastrado.</p>';
        return;
      }
      
      renderProducts(data.products);
      
    } catch (err) {
      console.error('Erro ao carregar produtos:', err);
    }
  }

  // Renderiza lista de produtos
  function renderProducts(products) {
    const container = document.getElementById('products-list');
    
    container.innerHTML = products.map(p => `
      <div style="background: var(--card-bg); padding: 20px; border-radius: 12px; border: 1px solid var(--border-color); display: flex; gap: 16px;">
        <img src="${p.imagem || 'https://via.placeholder.com/80'}" 
             alt="${p.nome}"
             style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px; background: #0b1020;">
        <div style="flex: 1;">
          <h3 style="margin: 0 0 4px 0;">${p.nome}</h3>
          <p style="margin: 0 0 4px 0; color: var(--muted); font-size: 14px;">${p.fabricante || 'Sem fabricante'} ‚Ä¢ SKU: ${p.sku || 'N/A'}</p>
          <p style="margin: 0; color: var(--primary); font-weight: 700;">R$ ${parseFloat(p.preco).toFixed(2).replace('.', ',')}</p>
          <p style="margin: 4px 0 0 0; color: var(--muted); font-size: 13px;">Estoque: ${p.estoque} unidades ‚Ä¢ Categoria: ${p.categoria_nome || 'N/A'}</p>
        </div>
        <div style="display: flex; flex-direction: column; gap: 8px;">
          <button onclick="openEditModal(${p.produto_id})" 
                  style="padding: 8px 16px; background: var(--primary); color: white; border: 0; border-radius: 6px; cursor: pointer; font-weight: 600;">
            Editar
          </button>
          <button onclick="deleteProduct(${p.produto_id})" 
                  style="padding: 8px 16px; background: #ef4444; color: white; border: 0; border-radius: 6px; cursor: pointer; font-weight: 600;">
            Excluir
          </button>
        </div>
      </div>
    `).join('');
  }

  // Adiciona produto
  async function handleSubmit(e) {
    e.preventDefault();
    
    const form = e.target;
    const submitBtn = form.querySelector('button[type="submit"]');
    
    submitBtn.disabled = true;
    submitBtn.textContent = 'Salvando...';
    
    try {
      const formData = {
        nome: form.nome.value,
        categoria_id: parseInt(form.categoria_id.value),
        fabricante: form.fabricante.value,
        descricao: form.descricao.value,
        especificacoes: form.especificacoes.value,
        sku: form.sku.value,
        preco: parseFloat(form.preco.value),
        estoque: parseInt(form.estoque.value) || 0,
        fornecedor_id: parseInt(form.fornecedor_id.value) || 1,
        imagem: form.imagem.value
      };
      
      const res = await fetch('php/admin_products.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(formData)
      });
      
      const data = await res.json();
      
      if (!data.success) {
        alert(data.error || 'Erro ao adicionar produto');
        return;
      }
      
      alert('Produto adicionado com sucesso!');
      form.reset();
      loadProducts();
      
    } catch (err) {
      console.error('Erro:', err);
      alert('Erro ao adicionar produto. Tente novamente.');
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = 'Adicionar Produto';
    }
  }

  // Abre modal de edi√ß√£o
  async function openEditModal(produtoId) {
    try {
      // Busca dados do produto
      const res = await fetch(`php/product.php?id=${produtoId}`);
      const data = await res.json();
      
      if (!data.success || !data.product) {
        alert('Erro ao carregar produto');
        return;
      }
      
      const p = data.product;
      
      // Preenche o formul√°rio
      document.getElementById('edit-produto-id').value = p.produto_id;
      document.getElementById('edit-nome').value = p.nome;
      document.getElementById('edit-categoria').value = p.categoria_id;
      document.getElementById('edit-fabricante').value = p.fabricante || '';
      document.getElementById('edit-descricao').value = p.descricao || '';
      document.getElementById('edit-especificacoes').value = p.especificacoes || '';
      document.getElementById('edit-sku').value = p.sku || '';
      document.getElementById('edit-preco').value = p.preco;
      document.getElementById('edit-estoque').value = p.estoque;
      document.getElementById('edit-fornecedor').value = p.fornecedor_id || 1;
      document.getElementById('edit-imagem').value = p.imagem || '';
      
      // Mostra o modal
      document.getElementById('edit-modal').style.display = 'block';
      document.body.style.overflow = 'hidden';
      
    } catch (err) {
      console.error('Erro:', err);
      alert('Erro ao abrir edi√ß√£o. Tente novamente.');
    }
  }

  // Fecha modal de edi√ß√£o
  function closeEditModal() {
    document.getElementById('edit-modal').style.display = 'none';
    document.body.style.overflow = 'auto';
    document.getElementById('edit-product-form').reset();
  }

  // Salva edi√ß√£o do produto
  async function handleEditSubmit(e) {
    e.preventDefault();
    
    const form = e.target;
    const submitBtn = form.querySelector('button[type="submit"]');
    
    submitBtn.disabled = true;
    submitBtn.textContent = 'Salvando...';
    
    try {
      const formData = {
        produto_id: parseInt(form.produto_id.value),
        nome: form.nome.value,
        categoria_id: parseInt(form.categoria_id.value),
        fabricante: form.fabricante.value,
        descricao: form.descricao.value,
        especificacoes: form.especificacoes.value,
        sku: form.sku.value,
        preco: parseFloat(form.preco.value),
        estoque: parseInt(form.estoque.value),
        fornecedor_id: parseInt(form.fornecedor_id.value) || 1,
        imagem: form.imagem.value
      };
      
      const res = await fetch('php/admin_products.php', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(formData)
      });
      
      const data = await res.json();
      
      if (!data.success) {
        alert(data.error || 'Erro ao atualizar produto');
        return;
      }
      
      alert('Produto atualizado com sucesso!');
      closeEditModal();
      loadProducts();
      
    } catch (err) {
      console.error('Erro:', err);
      alert('Erro ao atualizar produto. Tente novamente.');
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = 'Salvar Altera√ß√µes';
    }
  }

  // Deleta produto
  async function deleteProduct(produtoId) {
    if (!confirm('Tem certeza que deseja excluir este produto?')) {
      return;
    }
    
    try {
      const res = await fetch('php/admin_products.php', {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ produto_id: produtoId })
      });
      
      const data = await res.json();
      
      if (!data.success) {
        alert(data.error || 'Erro ao excluir produto');
        return;
      }
      
      alert('Produto exclu√≠do com sucesso!');
      loadProducts();
      
    } catch (err) {
      console.error('Erro:', err);
      alert('Erro ao excluir produto. Tente novamente.');
    }
  }

  // Event listeners
  document.getElementById('product-form').addEventListener('submit', handleSubmit);
  document.getElementById('edit-product-form').addEventListener('submit', handleEditSubmit);
  
  // Fecha modal ao clicar fora
  document.getElementById('edit-modal').addEventListener('click', (e) => {
    if (e.target.id === 'edit-modal') {
      closeEditModal();
    }
  });
  
  // Inicializa
  document.addEventListener('DOMContentLoaded', checkAdminAccess);
</script>

</body>
</html>
