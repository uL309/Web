<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagn√≥stico - Admin Produtos</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0a0e1a;
            color: #e6eef8;
            padding: 40px 20px;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        h1 { color: #00d4ff; margin-bottom: 30px; }
        h2 { color: #00d4ff; margin: 30px 0 15px 0; font-size: 20px; }
        .section {
            background: #0f1729;
            border: 1px solid #1a2332;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
        }
        .status {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 14px;
            margin-left: 10px;
        }
        .status.ok { background: #10b981; color: white; }
        .status.error { background: #ef4444; color: white; }
        .status.loading { background: #f59e0b; color: white; }
        
        pre {
            background: #0a0e1a;
            border: 1px solid #1a2332;
            border-radius: 8px;
            padding: 15px;
            overflow-x: auto;
            font-size: 13px;
            color: #94a3b8;
            margin-top: 10px;
        }
        
        button {
            background: #00d4ff;
            color: #0a0e1a;
            border: 0;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
            margin-top: 10px;
        }
        button:hover { background: #00b8e6; }
        button:disabled {
            background: #334155;
            color: #64748b;
            cursor: not-allowed;
        }
        
        .log-entry {
            padding: 8px 12px;
            border-left: 3px solid #00d4ff;
            background: #0a0e1a;
            margin-bottom: 8px;
            border-radius: 4px;
            font-size: 13px;
        }
        .log-entry.error { border-left-color: #ef4444; }
        .log-entry.success { border-left-color: #10b981; }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .card {
            background: #0a0e1a;
            border: 1px solid #1a2332;
            border-radius: 8px;
            padding: 15px;
        }
        .card h3 {
            font-size: 14px;
            color: #94a3b8;
            margin-bottom: 8px;
        }
        .card .value {
            font-size: 24px;
            font-weight: 700;
            color: #00d4ff;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Diagn√≥stico do Sistema de Produtos</h1>
        
        <div class="section">
            <h2>1. Verifica√ß√£o de Autentica√ß√£o
                <span id="auth-status" class="status loading">Verificando...</span>
            </h2>
            <pre id="auth-result">Aguardando...</pre>
        </div>

        <div class="section">
            <h2>2. Estrutura do Banco de Dados
                <span id="db-status" class="status loading">Verificando...</span>
            </h2>
            <div class="grid">
                <div class="card">
                    <h3>Categorias</h3>
                    <div class="value" id="cat-count">-</div>
                </div>
                <div class="card">
                    <h3>Fornecedores</h3>
                    <div class="value" id="forn-count">-</div>
                </div>
                <div class="card">
                    <h3>Produtos</h3>
                    <div class="value" id="prod-count">-</div>
                </div>
            </div>
            <pre id="db-result">Aguardando...</pre>
        </div>

        <div class="section">
            <h2>3. Teste de Cria√ß√£o de Produto</h2>
            <button onclick="testProductCreation()">‚ñ∂ Testar Cria√ß√£o</button>
            <button onclick="testWithInvalidData()">‚ö† Testar com Dados Inv√°lidos</button>
            <div id="test-logs" style="margin-top: 20px;"></div>
        </div>

        <div class="section">
            <h2>4. Logs do Sistema</h2>
            <button onclick="clearLogs()">üóë Limpar Logs</button>
            <div id="system-logs" style="margin-top: 15px;"></div>
        </div>
    </div>

    <script>
        const logs = [];
        
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString('pt-BR');
            logs.push({ timestamp, message, type });
            
            const logsDiv = document.getElementById('system-logs');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${timestamp}] ${message}`;
            logsDiv.insertBefore(entry, logsDiv.firstChild);
        }
        
        function clearLogs() {
            document.getElementById('system-logs').innerHTML = '';
            logs.length = 0;
            addLog('Logs limpos', 'info');
        }
        
        // 1. Verifica autentica√ß√£o
        async function checkAuth() {
            try {
                const res = await fetch('php/auth.php');
                const data = await res.json();
                
                document.getElementById('auth-result').textContent = JSON.stringify(data, null, 2);
                
                if (data.success && data.user && data.user.is_admin) {
                    document.getElementById('auth-status').textContent = 'OK - Admin';
                    document.getElementById('auth-status').className = 'status ok';
                    addLog('‚úì Autentica√ß√£o validada: usu√°rio √© admin', 'success');
                    return true;
                } else {
                    document.getElementById('auth-status').textContent = 'ERRO - N√£o Admin';
                    document.getElementById('auth-status').className = 'status error';
                    addLog('‚úó Erro: usu√°rio n√£o √© administrador', 'error');
                    return false;
                }
            } catch (err) {
                document.getElementById('auth-status').textContent = 'ERRO';
                document.getElementById('auth-status').className = 'status error';
                document.getElementById('auth-result').textContent = err.toString();
                addLog('‚úó Erro ao verificar autentica√ß√£o: ' + err.message, 'error');
                return false;
            }
        }
        
        // 2. Verifica estrutura do banco
        async function checkDatabase() {
            try {
                // Verifica produtos
                const resProd = await fetch('php/products.php?limit=1');
                const dataProd = await resProd.json();
                
                if (dataProd.success) {
                    document.getElementById('prod-count').textContent = dataProd.total || '?';
                    addLog(`‚úì Produtos no banco: ${dataProd.total}`, 'success');
                }
                
                // Tenta buscar categorias e fornecedores (se houver endpoint)
                document.getElementById('cat-count').textContent = '‚úì';
                document.getElementById('forn-count').textContent = '‚úì';
                
                document.getElementById('db-status').textContent = 'OK';
                document.getElementById('db-status').className = 'status ok';
                document.getElementById('db-result').textContent = 'Banco de dados acess√≠vel\n' + 
                    JSON.stringify(dataProd, null, 2);
                
                addLog('‚úì Banco de dados acess√≠vel', 'success');
                
            } catch (err) {
                document.getElementById('db-status').textContent = 'ERRO';
                document.getElementById('db-status').className = 'status error';
                document.getElementById('db-result').textContent = err.toString();
                addLog('‚úó Erro ao acessar banco: ' + err.message, 'error');
            }
        }
        
        // 3. Testa cria√ß√£o de produto
        async function testProductCreation() {
            const logsDiv = document.getElementById('test-logs');
            logsDiv.innerHTML = '<div class="log-entry">Iniciando teste...</div>';
            
            const testProduct = {
                nome: `TESTE GPU ${Date.now()}`,
                categoria_id: 5, // Placas de V√≠deo
                fabricante: 'NVIDIA',
                descricao: 'Produto de teste criado pelo diagn√≥stico',
                especificacoes: 'GPU: Test | Mem√≥ria: 24GB | Interface: 384-bit',
                sku: `TEST-GPU-${Date.now()}`,
                preco: 8999.99,
                estoque: 10,
                fornecedor_id: 1,
                imagem: 'https://via.placeholder.com/400'
            };
            
            logsDiv.innerHTML += `<div class="log-entry">Enviando dados:\n${JSON.stringify(testProduct, null, 2)}</div>`;
            addLog('Testando cria√ß√£o de produto...', 'info');
            
            try {
                const res = await fetch('php/admin_products.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testProduct)
                });
                
                const data = await res.json();
                
                logsDiv.innerHTML += `<div class="log-entry ${data.success ? 'success' : 'error'}">` +
                    `Status: ${res.status}\n` +
                    `Resposta: ${JSON.stringify(data, null, 2)}</div>`;
                
                if (data.success) {
                    addLog(`‚úì Produto criado com sucesso! ID: ${data.produto_id}`, 'success');
                    alert(`‚úì Sucesso! Produto criado com ID: ${data.produto_id}`);
                } else {
                    addLog(`‚úó Falha ao criar produto: ${data.error}`, 'error');
                    alert(`‚úó Erro: ${data.error}\n${data.details ? JSON.stringify(data.details) : ''}`);
                }
                
            } catch (err) {
                logsDiv.innerHTML += `<div class="log-entry error">Exce√ß√£o: ${err.toString()}</div>`;
                addLog('‚úó Exce√ß√£o ao testar cria√ß√£o: ' + err.message, 'error');
                alert('Erro de rede ou servidor: ' + err.message);
            }
        }
        
        // 4. Testa com dados inv√°lidos
        async function testWithInvalidData() {
            const logsDiv = document.getElementById('test-logs');
            logsDiv.innerHTML = '<div class="log-entry">Testando valida√ß√£o com dados inv√°lidos...</div>';
            
            const invalidProduct = {
                nome: '',
                categoria_id: 0,
                sku: '',
                preco: -100
            };
            
            addLog('Testando valida√ß√£o de dados...', 'info');
            
            try {
                const res = await fetch('php/admin_products.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(invalidProduct)
                });
                
                const data = await res.json();
                
                logsDiv.innerHTML += `<div class="log-entry ${res.status === 400 ? 'success' : 'error'}">` +
                    `Status: ${res.status} (esperado: 400)\n` +
                    `Resposta: ${JSON.stringify(data, null, 2)}</div>`;
                
                if (res.status === 400 && !data.success) {
                    addLog('‚úì Valida√ß√£o funcionando corretamente', 'success');
                    alert('‚úì Valida√ß√£o OK: dados inv√°lidos foram rejeitados');
                } else {
                    addLog('‚ö† Valida√ß√£o n√£o funcionou como esperado', 'error');
                }
                
            } catch (err) {
                logsDiv.innerHTML += `<div class="log-entry error">Exce√ß√£o: ${err.toString()}</div>`;
                addLog('‚úó Erro ao testar valida√ß√£o: ' + err.message, 'error');
            }
        }
        
        // Executa verifica√ß√µes ao carregar
        window.addEventListener('DOMContentLoaded', async () => {
            addLog('Sistema de diagn√≥stico iniciado', 'info');
            
            const isAdmin = await checkAuth();
            if (isAdmin) {
                await checkDatabase();
            }
        });
    </script>
</body>
</html>
