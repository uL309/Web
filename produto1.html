<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CiberTech - Placa de V√≠deo RTX 4070</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header>
    <div class="container topbar">
      <div class="brand">
        <div class="logo">CT</div>
        <div>
          <a href="index.html"><button class="icon-btn" style="font-weight:800;">CiberTech</button></a>
          <div style="font-size:12px;color:var(--muted)">Hardware ‚Ä¢ Perif√©ricos ‚Ä¢ Promo√ß√µes</div>
        </div>
      </div>

      <div class="search" role="search" aria-label="Busca de produtos">
        <input type="search" placeholder="Procure por placa, fonte, gabinete, monitor..." aria-label="buscar produto" />
        <button aria-label="Pesquisar">Buscar</button>
      </div>

      <div class="actions">
        <a href="carrinho.html"><button class="icon-btn" aria-label="Carrinho">üõí Carrinho</button></a>
        <a href="#"><button class="icon-btn" aria-label="Registrar">Registrar</button></a>
        <a href="#"><button class="icon-btn" aria-label="Login">Entrar</button></a>
        <a href="#"><button class="icon-btn" aria-label="Perfil">üë§</button></a>
      </div>
    </div>

   <div class="container" style="padding-bottom:10px">
      <nav style="display:flex;gap:12px;align-items:center">
        <a href="#">Placas-m√£e</a>
        <a href="#">Processadores</a>
        <a href="#">Placas de v√≠deo</a>
        <a href="#">Mem√≥ria RAM</a>
        <a href="#">SSD / HD</a>
        <a href="#">Fontes</a>
        <a href="#">Monitores</a>
        <a href="#">Perif√©ricos</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <section class="product-detail" style="display:flex;flex-wrap:wrap;gap:24px;margin-top:24px">
      <div style="flex:1 1 320px;">
        <img src="https://http.cat/images/402.jpg" 
             alt="Placa de V√≠deo RTX 4070" style="width:100%;border-radius:12px;"/>
      </div>
      <div style="flex:1 1 400px;">
        <h1>Placa de V√≠deo RTX 4070 - 12GB</h1>
        <div style="margin:12px 0;">
          <span class="price">R$ 3.499</span>
          <span class="old">R$ 4.199</span>
        </div>
        <div style="font-size:13px;color:var(--muted);margin-bottom:12px;">Em estoque ‚Ä¢ Garantia 5 anos</div>
        <button class="buy">Adicionar ao carrinho</button>
      </div>
    </section>

    <section style="margin-top:36px;" id="product-description">
      <h2>Descri√ß√£o</h2>
      <p id="description-text" style="color:var(--muted);line-height:1.6">
        Carregando descri√ß√£o...
      </p>
    </section>

    <section style="margin-top:24px;" id="product-specs">
      <h2>Especifica√ß√µes T√©cnicas</h2>
      <table style="width:100%;border-collapse:collapse;margin-top:12px" id="specs-table">
        <tr style="border-bottom:1px solid rgba(255,255,255,0.1)">
          <td colspan="2" style="padding:12px;text-align:center;color:var(--muted)">
            Carregando especifica√ß√µes...
          </td>
        </tr>
      </table>
    </section>

    <section style="margin-top:36px;">
      <h2>Avalia√ß√µes dos Clientes</h2>
      
      <form style="margin-bottom:24px">
        <label style="display:block;margin-bottom:6px">Escreva sua avalia√ß√£o:</label>
        <textarea placeholder="Conte-nos sua experi√™ncia..." style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.1);outline:none;margin-bottom:8px"></textarea>
        <button class="cta" type="submit">Enviar Avalia√ß√£o</button>
      </form>

      <div class="reviews">

      </div>
    </section>

  </main>

  <footer style="margin-top:18px">
  <div class="container">
    <div class="footer-content">
      <div class="footer-left">
        <div style="font-weight:800">CiberTech</div>
        <div style="color:var(--muted)">¬© 2025 ‚Ä¢ Todos os direitos reservados</div>
      </div>
      <div class="footer-right" style="color:var(--muted)">
        Pagamento seguro ‚Ä¢ Parcelamos em at√© 12x
        <a href="registrar_produto.html" style="margin-left:12px; color:var(--primary); text-decoration:none; font-weight:600;">
          Registrar produto
        </a>
      </div>
    </div>
  </div>
</footer>

  <script src="js/header.js"></script>
  <script>
    // Pega ID do produto da URL
    const urlParams = new URLSearchParams(window.location.search);
    const productId = urlParams.get('id') || 1;

    // Carrega produto do backend
    async function loadProduct() {
      try {
        const res = await fetch(`php/product.php?id=${productId}`);
        const data = await res.json();

        if (!data.success || !data.product) {
          alert('Produto n√£o encontrado');
          window.location.href = 'index.html';
          return;
        }

        const product = data.product;
        
        // Atualiza t√≠tulo da p√°gina
        document.title = `CiberTech - ${product.nome}`;

        // Atualiza conte√∫do
        const detailSection = document.querySelector('.product-detail');
        if (detailSection) {
          detailSection.innerHTML = `
            <div style="flex:1 1 320px;">
              <img src="${product.imagem || 'https://http.cat/images/404.jpg'}" 
                   alt="${product.nome}" style="width:100%;border-radius:12px;"/>
            </div>
            <div style="flex:1 1 400px;">
              <h1>${product.nome}</h1>
              <div style="margin:12px 0;">
                <span class="price">R$ ${parseFloat(product.preco).toFixed(2).replace('.', ',')}</span>
              </div>
              <div style="font-size:13px;color:var(--muted);margin-bottom:12px;">
                ${product.estoque > 0 ? `Em estoque (${product.estoque} unidades)` : 'Sem estoque'} 
                ${product.fabricante ? `‚Ä¢ ${product.fabricante}` : ''}
              </div>
              <p style="margin-bottom:16px;color:var(--muted);">${product.descricao || ''}</p>
              <button class="buy" data-product-id="${product.produto_id}" ${product.estoque === 0 ? 'disabled' : ''}>
                ${product.estoque > 0 ? 'Adicionar ao carrinho' : 'Indispon√≠vel'}
              </button>
            </div>
          `;

          attachBuyHandler();
          
          // Atualiza descri√ß√£o
          updateDescription(product);
          
          // Carrega especifica√ß√µes (pode vir de uma tabela separada ou JSON)
          loadSpecifications(product);
          
          // Carrega avalia√ß√µes se dispon√≠veis
          if (data.reviews) {
            loadReviews(data.reviews, data.rating);
          }
        }

      } catch (err) {
        console.error('Erro ao carregar produto:', err);
        alert('Erro ao carregar produto');
      }
    }
    
    // Atualiza a descri√ß√£o do produto
    function updateDescription(product) {
      const descText = document.getElementById('description-text');
      if (descText && product.descricao) {
        descText.textContent = product.descricao;
      } else if (descText) {
        descText.textContent = 'Descri√ß√£o n√£o dispon√≠vel para este produto.';
      }
    }
    
    // Carrega especifica√ß√µes t√©cnicas
    function loadSpecifications(product) {
      const specsTable = document.getElementById('specs-table');
      if (!specsTable) return;
      
      // Especifica√ß√µes b√°sicas que temos no banco
      const specs = [];
      
      if (product.nome) {
        specs.push(['Modelo', product.nome]);
      }
      
      if (product.fabricante) {
        specs.push(['Fabricante', product.fabricante]);
      }
      
      if (product.sku) {
        specs.push(['SKU', product.sku]);
      }
      
      if (product.categoria_nome) {
        specs.push(['Categoria', product.categoria_nome]);
      }
      
      // Parse especifica√ß√µes do campo texto (formato: "key: value | key: value")
      if (product.especificacoes) {
        try {
          const especText = product.especificacoes;
          
          // Tenta parsear como JSON primeiro
          if (especText.trim().startsWith('{')) {
            const extraSpecs = JSON.parse(especText);
            for (const [key, value] of Object.entries(extraSpecs)) {
              specs.push([key, value]);
            }
          } else {
            // Parse formato "key: value | key: value"
            const parts = especText.split('|').map(p => p.trim());
            parts.forEach(part => {
              const [key, value] = part.split(':').map(s => s.trim());
              if (key && value) {
                specs.push([key, value]);
              }
            });
          }
        } catch (e) {
          // Se falhar, adiciona como texto √∫nico
          specs.push(['Especifica√ß√µes', product.especificacoes]);
        }
      }
      
      if (product.estoque !== undefined) {
        specs.push(['Disponibilidade', product.estoque > 0 ? `Em estoque (${product.estoque} unidades)` : 'Sem estoque']);
      }
      
      if (specs.length === 0) {
        specsTable.innerHTML = `
          <tr>
            <td colspan="2" style="padding:12px;text-align:center;color:var(--muted)">
              Especifica√ß√µes t√©cnicas n√£o dispon√≠veis
            </td>
          </tr>
        `;
        return;
      }
      
      specsTable.innerHTML = specs.map(([label, value]) => `
        <tr style="border-bottom:1px solid rgba(255,255,255,0.1)">
          <th style="text-align:left;padding:8px;color:var(--muted);width:40%">${label}</th>
          <td style="padding:8px">${value}</td>
        </tr>
      `).join('');
    }
    
    // Carrega avalia√ß√µes do produto
    function loadReviews(reviews, rating) {
      const reviewsDiv = document.querySelector('.reviews');
      if (!reviewsDiv) return;
      
      // Mostra m√©dia de avalia√ß√£o
      if (rating && rating.count > 0) {
        const ratingHTML = `
          <div style="background:rgba(255,255,255,0.05);padding:16px;border-radius:8px;margin-bottom:20px">
            <div style="display:flex;align-items:center;gap:12px">
              <div style="font-size:32px;font-weight:800">${rating.average.toFixed(1)}</div>
              <div>
                <div style="color:#ffd700">${'‚òÖ'.repeat(Math.round(rating.average))}${'‚òÜ'.repeat(5-Math.round(rating.average))}</div>
                <div style="font-size:13px;color:var(--muted)">${rating.count} avalia√ß√µes</div>
              </div>
            </div>
          </div>
        `;
        reviewsDiv.insertAdjacentHTML('beforebegin', ratingHTML);
      }
      
      if (reviews.length === 0) {
        reviewsDiv.innerHTML = '<p style="color:var(--muted);text-align:center;padding:20px">Ainda n√£o h√° avalia√ß√µes para este produto. Seja o primeiro a avaliar!</p>';
        return;
      }
      
      reviewsDiv.innerHTML = reviews.map(review => `
        <div style="background:rgba(255,255,255,0.05);padding:16px;border-radius:8px;margin-bottom:12px">
          <div style="display:flex;justify-content:space-between;margin-bottom:8px">
            <strong>${review.usuario_nome || 'Cliente'}</strong>
            <span style="color:#ffd700">${'‚òÖ'.repeat(review.nota)}${'‚òÜ'.repeat(5-review.nota)}</span>
          </div>
          <p style="color:var(--muted);margin:0">${review.comentario}</p>
          <small style="color:var(--muted);font-size:12px">${new Date(review.data_avaliacao).toLocaleDateString('pt-BR')}</small>
        </div>
      `).join('');
    }

    // Adiciona ao carrinho
    async function addToCart(productId) {
      try {
        const res = await fetch('php/cart.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ produto_id: productId, quantidade: 1 })
        });

        const data = await res.json();
        
        if (!data.success) {
          alert(data.error || 'Erro ao adicionar ao carrinho');
          return false;
        }
        
        return true;
      } catch (err) {
        console.error('Erro ao adicionar ao carrinho:', err);
        alert('Erro ao adicionar produto. Tente novamente.');
        return false;
      }
    }

    // Configura handler do bot√£o
    function attachBuyHandler() {
      const btn = document.querySelector('.buy');
      if (!btn) return;

      btn.addEventListener('click', async () => {
        const productId = btn.dataset.productId;
        if (!productId) return;

        btn.disabled = true;
        btn.textContent = 'Adicionando...';

        const success = await addToCart(productId);

        if (success) {
          btn.textContent = 'Adicionado ‚úì';
          btn.style.opacity = '0.9';
          setTimeout(() => {
            btn.textContent = 'Adicionar ao carrinho';
            btn.disabled = false;
            btn.style.opacity = '1';
          }, 2000);
        } else {
          btn.textContent = 'Adicionar ao carrinho';
          btn.disabled = false;
        }
      });
    }

    document.addEventListener('DOMContentLoaded', loadProduct);
  </script>
</body>
</html>

