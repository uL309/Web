<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CiberTech - Placa de Vídeo RTX 4070</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header>
    <div class="container topbar">
      <div class="brand">
        <div class="logo">CT</div>
        <div>
          <a href="index.html"><button class="icon-btn" style="font-weight:800;">CiberTech</button></a>
          <div style="font-size:12px;color:var(--muted)">Hardware • Periféricos • Promoções</div>
        </div>
      </div>

      <div class="search" role="search" aria-label="Busca de produtos">
        <input type="search" id="main-search" placeholder="Procure por placa, fonte, gabinete, monitor..." aria-label="buscar produto" />
        <button id="search-btn" aria-label="Pesquisar">Buscar</button>
      </div>

      <div class="actions">
        <!-- Populado por js/header.js -->
      </div>
    </div>

   <div class="container" style="padding-bottom:10px">
      <nav style="display:flex;gap:12px;align-items:center" id="category-nav">
        <a href="#" data-category="7">Placas-mãe</a>
        <a href="#" data-category="6">Processadores</a>
        <a href="#" data-category="5">Placas de vídeo</a>
        <!-- ... outros links ... -->
      </nav>
    </div>
  </header>

  <main class="container">
    <section class="product-detail" style="display:flex;flex-wrap:wrap;gap:24px;margin-top:24px">
      <!-- Conteúdo será carregado por JavaScript -->
      <div style="flex:1 1 320px; min-height: 300px; background: var(--card-bg); border-radius: 12px;"></div>
      <div style="flex:1 1 400px;">
        <h1 style="min-height: 40px; background: var(--card-bg); border-radius: 8px;"></h1>
        <div style="min-height: 30px; background: var(--card-bg); border-radius: 8px; margin: 12px 0;"></div>
        <button class="buy" disabled>Carregando...</button>
      </div>
    </section>

    <section style="margin-top:36px;" id="product-description">
      <h2>Descrição</h2>
      <p id="description-text" style="color:var(--muted);line-height:1.6">
        Carregando descrição...
      </p>
    </section>

    <section style="margin-top:24px;" id="product-specs">
      <h2>Especificações Técnicas</h2>
      <table style="width:100%;border-collapse:collapse;margin-top:12px" id="specs-table">
        <tr style="border-bottom:1px solid rgba(255,255,255,0.1)">
          <td colspan="2" style="padding:12px;text-align:center;color:var(--muted)">
            Carregando especificações...
          </td>
        </tr>
      </table>
    </section>

    <section style="margin-top:36px;">
      <h2>Avaliações dos Clientes</h2>
      
      <!-- Mensagem de Feedback da Avaliação -->
      <div id="review-message" style="display: none; padding: 16px; margin-bottom: 24px; border-radius: 8px; font-weight: 600;"></div>

      <!-- ** FORMULÁRIO DE AVALIAÇÃO CORRIGIDO ** -->
      <form id="review-form" style="margin-bottom:24px; background: var(--card-bg); padding: 24px; border-radius: 12px; border: 1px solid var(--border-color);">
        <h3 style="margin: 0 0 16px 0;">Escreva sua avaliação:</h3>
        
        <div style="margin-bottom: 16px;">
          <label for="nota" style="display:block;margin-bottom:6px; font-weight: 600;">Nota (1 a 5 estrelas)</label>
          <select id="nota" name="nota" required style="width:100%; padding:10px; border-radius:8px; border:0; background: #0b1020; color: #e6eef8;">
            <option value="">Selecione uma nota</option>
            <option value="5">★★★★★ (5 estrelas)</option>
            <option value="4">★★★★☆ (4 estrelas)</option>
            <option value="3">★★★☆☆ (3 estrelas)</option>
            <option value="2">★★☆☆☆ (2 estrelas)</option>
            <option value="1">★☆☆☆☆ (1 estrela)</option>
          </select>
        </div>
        
        <div style="margin-bottom: 16px;">
          <label for="comentario" style="display:block;margin-bottom:6px; font-weight: 600;">Comentário</label>
          <textarea id="comentario" name="comentario" placeholder="Conte-nos sua experiência..." rows="4" required style="width:100%;padding:10px;border-radius:8px;border:0; background: #0b1020; color: #e6eef8; resize: vertical;"></textarea>
        </div>
        
        <button class="cta" type="submit">Enviar Avaliação</button>
      </form>
      <!-- Fim do formulário corrigido -->

      <div class="reviews">
        <!-- Avaliações serão carregadas aqui -->
      </div>
    </section>

  </main>

  <footer style="margin-top:18px">
    <div class="container">
      <div class="footer-content">
        <div class="footer-left">
          <div style="font-weight:800">CiberTech</div>
          <div style="color:var(--muted)">© 2025 • Todos os direitos reservados</div>
        </div>
        <div class="footer-right" style="color:var(--muted)">
          Pagamento seguro • Parcelamos em até 12x
          <!-- ** LINK CORRIGIDO ** -->
          <a href="admin-produtos.html" style="margin-left:12px; color:var(--primary); text-decoration:none; font-weight:600;">
            Admin
          </a>
        </div>
      </div>
    </div>
  </footer>

  <script src="js/header.js"></script>
  <script>
    // Pega ID do produto da URL
    const urlParams = new URLSearchParams(window.location.search);
    const productId = urlParams.get('id'); // Não definir um padrão, deve ser explícito

    if (!productId) {
        alert('Produto não especificado.');
        window.location.href = 'index.html';
    }

    // Carrega produto do backend
    async function loadProduct() {
      try {
        const res = await fetch(`php/product.php?id=${productId}`);
        const data = await res.json();

        if (!data.success || !data.product) {
          alert('Produto não encontrado');
          window.location.href = 'index.html';
          return;
        }

        const product = data.product;
        
        // Atualiza título da página
        document.title = `CiberTech - ${product.nome}`;

        // Atualiza conteúdo
        const detailSection = document.querySelector('.product-detail');
        if (detailSection) {
          detailSection.innerHTML = `
            <div style="flex:1 1 320px;">
              <img src="${product.imagem || 'https://via.placeholder.com/400x300/1a1a2e/00ff88?text=Sem+Imagem'}" 
                   alt="${product.nome}" style="width:100%;border-radius:12px;"/>
            </div>
            <div style="flex:1 1 400px;">
              <h1>${product.nome}</h1>
              <div style="margin:12px 0;">
                <span class="price">R$ ${parseFloat(product.preco).toFixed(2).replace('.', ',')}</span>
              </div>
              <div style="font-size:13px;color:var(--muted);margin-bottom:12px;">
                ${product.estoque > 0 ? `Em estoque (${product.estoque} unidades)` : 'Sem estoque'} 
                ${product.fabricante ? `• ${product.fabricante}` : ''}
              </div>
              <p style="margin-bottom:16px;color:var(--muted);">${product.descricao || ''}</p>
              <button class="buy" data-product-id="${product.produto_id}" ${product.estoque <= 0 ? 'disabled' : ''}>
                ${product.estoque > 0 ? 'Adicionar ao carrinho' : 'Indisponível'}
              </button>
            </div>
          `;

          attachBuyHandler();
          
          // Atualiza descrição
          updateDescription(product);
          
          // Carrega especificações
          loadSpecifications(product);
          
          // Carrega avaliações
          loadReviews(data.reviews || [], data.rating);
        }

      } catch (err) {
        console.error('Erro ao carregar produto:', err);
        alert('Erro ao carregar produto');
      }
    }
    
    // Atualiza a descrição
    function updateDescription(product) {
      const descText = document.getElementById('description-text');
      if (descText && product.descricao) {
        descText.textContent = product.descricao;
      } else if (descText) {
        descText.textContent = 'Descrição não disponível para este produto.';
      }
    }
    
    // Carrega especificações técnicas
    function loadSpecifications(product) {
      const specsTable = document.getElementById('specs-table');
      if (!specsTable) return;
      
      const specs = [];
      if (product.nome) specs.push(['Modelo', product.nome]);
      if (product.fabricante) specs.push(['Fabricante', product.fabricante]);
      if (product.sku) specs.push(['SKU', product.sku]);
      if (product.categoria_nome) specs.push(['Categoria', product.categoria_nome]);
      
      // Parse especificações (formato: "key: value | key: value")
      if (product.especificacoes) {
        try {
            const parts = product.especificacoes.split('|').map(p => p.trim());
            parts.forEach(part => {
              const [key, value] = part.split(':').map(s => s.trim());
              if (key && value) {
                specs.push([key, value]);
              } else if (key) {
                specs.push(['Info', key]); // Se não houver ':'
              }
            });
        } catch (e) {
          specs.push(['Especificações', product.especificacoes]);
        }
      }
      
      if (product.estoque !== undefined) {
        specs.push(['Disponibilidade', product.estoque > 0 ? `Em estoque (${product.estoque} unidades)` : 'Sem estoque']);
      }
      
      if (specs.length === 0) {
        specsTable.innerHTML = `<tr><td colspan="2" style="padding:12px;text-align:center;color:var(--muted)">Especificações não disponíveis</td></tr>`;
        return;
      }
      
      specsTable.innerHTML = specs.map(([label, value]) => `
        <tr style="border-bottom:1px solid rgba(255,255,255,0.1)">
          <th style="text-align:left;padding:8px;color:var(--muted);width:40%">${label}</th>
          <td style="padding:8px">${value}</td>
        </tr>
      `).join('');
    }
    
    // Carrega avaliações
    function loadReviews(reviews, rating) {
      const reviewsDiv = document.querySelector('.reviews');
      const reviewSection = reviewsDiv.closest('section');
      
      // Mostra média
      if (rating && rating.count > 0) {
        const ratingHTML = `
          <div style="background:rgba(255,255,255,0.05);padding:16px;border-radius:8px;margin-bottom:20px">
            <div style="display:flex;align-items:center;gap:12px">
              <div style="font-size:32px;font-weight:800">${rating.average.toFixed(1)}</div>
              <div>
                <div style="color:#ffd700">${'★'.repeat(Math.round(rating.average))}${'☆'.repeat(5-Math.round(rating.average))}</div>
                <div style="font-size:13px;color:var(--muted)">${rating.count} avaliações</div>
              </div>
            </div>
          </div>
        `;
        reviewSection.insertAdjacentHTML('afterbegin', ratingHTML);
      }
      
      if (reviews.length === 0) {
        reviewsDiv.innerHTML = '<p style="color:var(--muted);text-align:center;padding:20px">Ainda não há avaliações para este produto.</p>';
        return;
      }
      
      reviewsDiv.innerHTML = reviews.map(review => `
        <div style="background:rgba(255,255,255,0.05);padding:16px;border-radius:8px;margin-bottom:12px">
          <div style="display:flex;justify-content:space-between;margin-bottom:8px">
            <strong>${review.cliente_nome || 'Cliente'}</strong>
            <span style="color:#ffd700">${'★'.repeat(review.nota)}${'☆'.repeat(5-review.nota)}</span>
          </div>
          <p style="color:var(--muted);margin:0">${review.comentario}</p>
          <small style="color:var(--muted);font-size:12px">${new Date(review.data).toLocaleDateString('pt-BR')}</small>
        </div>
      `).join('');
    }

    // Adiciona ao carrinho
    async function addToCart(productId) {
      try {
        const res = await fetch('php/cart.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ produto_id: productId, quantidade: 1 })
        });
        const data = await res.json();
        if (!data.success) {
          alert(data.error || 'Erro ao adicionar ao carrinho');
          return false;
        }
        return true;
      } catch (err) {
        console.error('Erro ao adicionar ao carrinho:', err);
        alert('Erro ao adicionar produto. Tente novamente.');
        return false;
      }
    }

    // Handler do botão comprar
    function attachBuyHandler() {
      const btn = document.querySelector('.buy');
      if (!btn) return;
      btn.addEventListener('click', async () => {
        // ... (lógica de adicionar ao carrinho, igual à anterior) ...
        const productId = btn.dataset.productId;
        if (!productId) return;
        btn.disabled = true;
        btn.textContent = 'Adicionando...';
        const success = await addToCart(productId);
        if (success) {
          btn.textContent = 'Adicionado ✓';
          setTimeout(() => {
            btn.textContent = 'Adicionar ao carrinho';
            btn.disabled = false;
          }, 2000);
        } else {
          btn.textContent = 'Adicionar ao carrinho';
          btn.disabled = false;
        }
      });
    }
    
    // **NOVO: Handler do formulário de avaliação**
    const reviewForm = document.getElementById('review-form');
    if (reviewForm) {
      reviewForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = reviewForm.querySelector('button[type="submit"]');
        const messageDiv = document.getElementById('review-message');
        
        const payload = {
            produto_id: parseInt(productId),
            nota: parseInt(document.getElementById('nota').value),
            comentario: document.getElementById('comentario').value
        };
        
        if (!payload.nota) {
            messageDiv.textContent = 'Por favor, selecione uma nota.';
            messageDiv.style.color = '#ef4444';
            messageDiv.style.backgroundColor = '#7f1d1d';
            messageDiv.style.display = 'block';
            return;
        }
        
        btn.disabled = true;
        btn.textContent = 'Enviando...';
        messageDiv.style.display = 'none';
        
        try {
            const res = await fetch('php/reviews.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const data = await res.json();
            
            if (!data.success) {
                throw new Error(data.error || 'Erro desconhecido');
            }
            
            messageDiv.textContent = 'Avaliação enviada com sucesso! Recarregando...';
            messageDiv.style.color = '#10b981';
            messageDiv.style.backgroundColor = '#064e3b';
            messageDiv.style.display = 'block';
            reviewForm.reset();
            
            setTimeout(() => location.reload(), 2000);
            
        } catch (err) {
            messageDiv.textContent = `Erro: ${err.message}`;
            messageDiv.style.color = '#ef4444';
            messageDiv.style.backgroundColor = '#7f1d1d';
            messageDiv.style.display = 'block';
            btn.disabled = false;
            btn.textContent = 'Enviar Avaliação';
        }
      });
    }

    document.addEventListener('DOMContentLoaded', loadProduct);
  </script>
</body>
</html>