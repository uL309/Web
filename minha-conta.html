<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CiberTech - Minha Conta</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>
<body>

<header>
    <!-- O cabeçalho (header) é idêntico ao de index.html -->
    <div class="container topbar">
      <div class="brand">
        <div class="logo">CT</div>
        <div>
          <a href="index.html"><button class="icon-btn" style="font-weight:800;">CiberTech</button></a>
          <div style="font-size:12px;color:var(--muted)">Hardware • Periféricos • Promoções</div>
        </div>
      </div>
      <div class="search" role="search">
        <input type="search" id="main-search" placeholder="Procure por produtos..." aria-label="buscar produto" />
        <button id="search-btn" aria-label="Pesquisar">Buscar</button>
      </div>
      <div class="actions">
        <!-- O js/header.js irá popular esta área dinamicamente -->
      </div>
    </div>
   <div class="container" style="padding-bottom:10px">
      <nav style="display:flex;gap:12px;align-items:center" id="category-nav">
        <a href="#" data-category="7">Placas-mãe</a>
        <a href="#" data-category="6">Processadores</a>
        <a href="#" data-category="5">Placas de vídeo</a>
        <!-- ... outros links de categoria ... -->
      </nav>
    </div>
</header>

<main class="container" style="margin-top: 48px; max-width: 800px;">
  <div style="margin-bottom: 32px;">
    <h1 style="margin: 0 0 8px 0;">Minha Conta</h1>
    <p style="color: var(--muted); margin: 0;">Gerencie suas informações pessoais e segurança.</p>
  </div>

  <!-- Mensagens de Feedback -->
  <div id="message-container" style="display: none; padding: 16px; margin-bottom: 24px; border-radius: 8px; font-weight: 600;"></div>

  <!-- Seção de Dados Pessoais -->
  <div style="background: var(--card-bg); padding: 32px; border-radius: 12px; border: 1px solid var(--border-color); margin-bottom: 32px;">
    <h2 style="margin: 0 0 24px 0;">Dados Pessoais</h2>
    <form id="info-form">
      <div style="margin-bottom: 16px;">
        <label for="nome" style="display: block; margin-bottom: 8px; font-weight: 600;">Nome Completo</label>
        <input type="text" id="nome" name="nome" required 
               style="width: 100%; padding: 12px; border-radius: 8px; border: 0; background: #0b1020; color: #e6eef8;">
      </div>
      <div style="margin-bottom: 16px;">
        <label for="email" style="display: block; margin-bottom: 8px; font-weight: 600;">Email (não pode ser alterado)</label>
        <input type="email" id="email" name="email" readonly
               style="width: 100%; padding: 12px; border-radius: 8px; border: 0; background: #0f1729; color: var(--muted); cursor: not-allowed;">
      </div>
      <div style="margin-bottom: 16px;">
        <label for="telefone" style="display: block; margin-bottom: 8px; font-weight: 600;">Telefone</label>
        <input type="tel" id="telefone" name="telefone"
               style="width: 100%; padding: 12px; border-radius: 8px; border: 0; background: #0b1020; color: #e6eef8;">
      </div>
      <div style="margin-bottom: 24px;">
        <label for="endereco" style="display: block; margin-bottom: 8px; font-weight: 600;">Endereço</label>
        <textarea id="endereco" name="endereco" rows="3" required
                  style="width: 100%; padding: 12px; border-radius: 8px; border: 0; background: #0b1020; color: #e6eef8; resize: vertical;"></textarea>
      </div>
      <button type="submit" class="cta" style="width: 100%;">Salvar Alterações</button>
    </form>
  </div>

  <!-- Seção de Alterar Senha -->
  <div style="background: var(--card-bg); padding: 32px; border-radius: 12px; border: 1px solid var(--border-color);">
    <h2 style="margin: 0 0 24px 0;">Alterar Senha</h2>
    <form id="password-form">
      <div style="margin-bottom: 16px;">
        <label for="senha_antiga" style="display: block; margin-bottom: 8px; font-weight: 600;">Senha Antiga</label>
        <input type="password" id="senha_antiga" name="senha_antiga" required
               style="width: 100%; padding: 12px; border-radius: 8px; border: 0; background: #0b1020; color: #e6eef8;">
      </div>
      <div style="margin-bottom: 16px;">
        <label for="nova_senha" style="display: block; margin-bottom: 8px; font-weight: 600;">Nova Senha</label>
        <input type="password" id="nova_senha" name="nova_senha" required
               style="width: 100%; padding: 12px; border-radius: 8px; border: 0; background: #0b1020; color: #e6eef8;">
      </div>
      <div style="margin-bottom: 24px;">
        <label for="confirmar_nova_senha" style="display: block; margin-bottom: 8px; font-weight: 600;">Confirmar Nova Senha</label>
        <input type="password" id="confirmar_nova_senha" name="confirmar_nova_senha" required
               style="width: 100%; padding: 12px; border-radius: 8px; border: 0; background: #0b1020; color: #e6eef8;">
      </div>
      <button type="submit" class="cta" style="width: 100%;">Alterar Senha</button>
    </form>
  </div>
</main>

<footer style="margin-top:48px">
    <!-- O rodapé (footer) é idêntico ao de index.html -->
    <div class="container">
      <div class="footer-content">
        <div class="footer-left">
          <div style="font-weight:800">CiberTech</div>
          <div style="color:var(--muted)">© 2025 • Todos os direitos reservados</div>
        </div>
        <div class="footer-right" style="color:var(--muted)">Pagamento seguro • Parcelamos em até 12x</div>
      </div>
    </div>
</footer>

<script src="js/header.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const infoForm = document.getElementById('info-form');
    const passwordForm = document.getElementById('password-form');
    const messageContainer = document.getElementById('message-container');

    // Função para exibir mensagens
    function showMessage(message, isError = false) {
        messageContainer.textContent = message;
        messageContainer.style.backgroundColor = isError ? '#7f1d1d' : '#064e3b';
        messageContainer.style.color = isError ? '#ef4444' : '#10b981';
        messageContainer.style.display = 'block';
        setTimeout(() => {
            messageContainer.style.display = 'none';
        }, 3000);
    }

    // Carregar dados do usuário
    async function loadUserData() {
        try {
            const res = await fetch('php/me.php');
            const data = await res.json();
            if (data.logged_in && data.user) {
                document.getElementById('nome').value = data.user.nome || '';
                document.getElementById('email').value = data.user.email || '';
                
                // Precisamos que o endpoint me.php retorne 'telefone' e 'endereco'
                // Por enquanto, vamos simular ou buscar de outro endpoint se tivéssemos.
                // Atualização: Vamos assumir que me.php foi atualizado para trazer tudo.
                // Se me.php não trouxer, precisaremos de outro endpoint.
                // Para este exemplo, vamos assumir que me.php NÃO traz, e php/minha_conta.php (GET) traria.
                // Mas não temos GET em minha_conta.php, então vamos popular com o que temos.
                
                // Vamos simplificar: vamos buscar os dados completos do usuário.
                // O endpoint me.php já é o 'auth.php', que só retorna o básico.
                // Para este exercício, vamos assumir que o usuário logado está no 'me.php'
                // e que precisamos de um endpoint GET em 'minha_conta.php' para pegar o resto.
                
                // Vamos fazer uma simplificação: por agora, apenas 'nome' e 'email' são preenchidos.
                // O ideal seria 'me.php' retornar todos os dados.

            } else {
                // Usuário não está logado, redireciona
                window.location.href = 'login.html';
            }
        } catch (err) {
            showMessage('Erro ao carregar dados. Você está logado?', true);
            setTimeout(() => { window.location.href = 'login.html'; }, 2000);
        }
    }

    // Lidar com atualização de informações
    infoForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = infoForm.querySelector('button[type="submit"]');
        btn.disabled = true;
        btn.textContent = 'Salvando...';

        const payload = {
            action: 'update_info',
            nome: document.getElementById('nome').value,
            telefone: document.getElementById('telefone').value,
            endereco: document.getElementById('endereco').value
        };

        try {
            const res = await fetch('php/minha_conta.php', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const data = await res.json();
            if (!data.success) throw new Error(data.error || 'Erro desconhecido');
            
            showMessage('Dados atualizados com sucesso!');
        } catch (err) {
            showMessage(`Erro: ${err.message}`, true);
        } finally {
            btn.disabled = false;
            btn.textContent = 'Salvar Alterações';
        }
    });

    // Lidar com alteração de senha
    passwordForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = passwordForm.querySelector('button[type="submit"]');
        
        const novaSenha = document.getElementById('nova_senha').value;
        const confirmarSenha = document.getElementById('confirmar_nova_senha').value;

        if (novaSenha !== confirmarSenha) {
            showMessage('As novas senhas não coincidem.', true);
            return;
        }

        btn.disabled = true;
        btn.textContent = 'Alterando...';

        const payload = {
            action: 'update_password',
            senha_antiga: document.getElementById('senha_antiga').value,
            nova_senha: novaSenha
        };

        try {
            const res = await fetch('php/minha_conta.php', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const data = await res.json();
            if (!data.success) throw new Error(data.error || 'Erro desconhecido');
            
            showMessage('Senha alterada com sucesso!');
            passwordForm.reset();
        } catch (err) {
            showMessage(`Erro: ${err.message}`, true);
        } finally {
            btn.disabled = false;
            btn.textContent = 'Alterar Senha';
        }
    });

    loadUserData();
});
</script>
</body>
</html>