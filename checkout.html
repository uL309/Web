<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CiberTech - Checkout</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>
<body>

<header>
    <div class="container topbar">
      <div class="brand">
        <div class="logo">CT</div>
        <div>
          <a href="index.html"><button class="icon-btn" style="font-weight:800;">CiberTech</button></a>
          <div style="font-size:12px;color:var(--muted)">Hardware ‚Ä¢ Perif√©ricos ‚Ä¢ Promo√ß√µes</div>
        </div>
      </div>

      <div class="search" role="search" aria-label="Busca de produtos">
        <input type="search" placeholder="Procure por placa, fonte, gabinete, monitor..." aria-label="buscar produto" />
        <button aria-label="Pesquisar">Buscar</button>
      </div>

      <div class="actions">
        <a href="carrinho.html"><button class="icon-btn" aria-label="Carrinho">üõí Carrinho</button></a>
        <a href="registro_cliente.html"><button class="icon-btn" aria-label="Registrar">Registrar</button></a>
        <a href="login.html"><button class="icon-btn" aria-label="Login">Entrar</button></a>
        <a href="#"><button class="icon-btn" aria-label="Perfil">üë§</button></a>
      </div>
    </div>

   <div class="container" style="padding-bottom:10px">
      <nav style="display:flex;gap:12px;align-items:center">
        <a href="#">Placas-m√£e</a>
        <a href="#">Processadores</a>
        <a href="#">Placas de v√≠deo</a>
        <a href="#">Mem√≥ria RAM</a>
        <a href="#">SSD / HD</a>
        <a href="#">Fontes</a>
        <a href="#">Monitores</a>
        <a href="#">Perif√©ricos</a>
      </nav>
    </div>
  </header>

<main class="container">
  <h1 style="margin-bottom:20px;">Checkout</h1>
  <div class="main">
    <div class="sidebar">
      <div class="filter">
        <h2 style="margin-top:0;">Resumo do Pedido</h2>
        <ul style="list-style:none; padding:0; margin:0;">
          <li style="display:flex; justify-content:space-between; margin-bottom:8px;">
            <span>RTX 4070 - 12GB</span> <span>R$ 3.499,00</span>
          </li>
          <li style="display:flex; justify-content:space-between; margin-bottom:8px;">
            <span>SSD NVMe 1TB - Leitura 7000MB/s</span> <span>R$ 449,00</span>
          </li>
          <li style="display:flex; justify-content:space-between; font-weight:800; margin-top:12px;">
            <span>Total</span> <span>R$ 3.948,00</span>
          </li>
        </ul>
      </div>
    </div>

    <div class="hero-card">
      <h2>Informa√ß√µes de Pagamento</h2>
      <form id="checkout-form">
        
        <!-- Sele√ß√£o de M√©todo de Pagamento -->
        <div style="margin-bottom:20px;">
          <label style="display:block;margin-bottom:8px;font-weight:600">M√©todo de Pagamento</label>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
            <label style="display:flex;align-items:center;padding:12px;border:2px solid rgba(255,255,255,0.1);border-radius:8px;cursor:pointer;transition:all 0.3s" class="payment-option">
              <input type="radio" name="payment_method" value="credit_card" checked style="margin-right:8px">
              <span>üí≥ Cart√£o de Cr√©dito</span>
            </label>
            <label style="display:flex;align-items:center;padding:12px;border:2px solid rgba(255,255,255,0.1);border-radius:8px;cursor:pointer;transition:all 0.3s" class="payment-option">
              <input type="radio" name="payment_method" value="debit_card" style="margin-right:8px">
              <span>üí≥ Cart√£o de D√©bito</span>
            </label>
            <label style="display:flex;align-items:center;padding:12px;border:2px solid rgba(255,255,255,0.1);border-radius:8px;cursor:pointer;transition:all 0.3s" class="payment-option">
              <input type="radio" name="payment_method" value="pix" style="margin-right:8px">
              <span>üì± PIX</span>
            </label>
            <label style="display:flex;align-items:center;padding:12px;border:2px solid rgba(255,255,255,0.1);border-radius:8px;cursor:pointer;transition:all 0.3s" class="payment-option">
              <input type="radio" name="payment_method" value="boleto" style="margin-right:8px">
              <span>üßæ Boleto</span>
            </label>
          </div>
        </div>

        <!-- Campos de Cart√£o (mostrar apenas se cart√£o selecionado) -->
        <div id="card-fields">
          <div style="margin-bottom:12px;">
            <label for="name">Nome no cart√£o</label><br>
            <input type="text" id="name" name="name" placeholder="Nome completo" style="width:100%; padding:10px; border-radius:8px; border:0;background:#0b1020;color:#e6eef8">
          </div>
          <div style="margin-bottom:12px;">
            <label for="card">N√∫mero do cart√£o</label><br>
            <input type="text" id="card" name="card" placeholder="0000 0000 0000 0000" maxlength="19" style="width:100%; padding:10px; border-radius:8px; border:0;background:#0b1020;color:#e6eef8">
          </div>
          <div style="display:flex; gap:10px; margin-bottom:12px;">
            <div style="flex:1;">
              <label for="expiry">Validade</label><br>
              <input type="text" id="expiry" name="expiry" placeholder="MM/AA" maxlength="5" style="width:100%; padding:10px; border-radius:8px; border:0;background:#0b1020;color:#e6eef8">
            </div>
            <div style="flex:1;">
              <label for="cvv">CVV</label><br>
              <input type="text" id="cvv" name="cvv" placeholder="123" maxlength="4" style="width:100%; padding:10px; border-radius:8px; border:0;background:#0b1020;color:#e6eef8">
            </div>
          </div>
          
          <!-- Parcelas (apenas para cart√£o de cr√©dito) -->
          <div style="margin-bottom:12px;" id="installments-field">
            <label for="installments">N√∫mero de parcelas</label><br>
            <select id="installments" name="installments" style="width:100%; padding:10px; border-radius:8px; border:0;background:#0b1020;color:#e6eef8">
              <option value="1">1x √† vista (sem juros)</option>
              <option value="2">2x sem juros</option>
              <option value="3">3x sem juros</option>
              <option value="4">4x sem juros</option>
              <option value="5">5x sem juros</option>
              <option value="6">6x sem juros</option>
              <option value="7">7x sem juros</option>
              <option value="8">8x sem juros</option>
              <option value="9">9x sem juros</option>
              <option value="10">10x sem juros</option>
              <option value="11">11x sem juros</option>
              <option value="12">12x sem juros</option>
            </select>
          </div>
        </div>

        <!-- Informa√ß√µes PIX (oculto por padr√£o) -->
        <div id="pix-info" style="display:none;margin-bottom:20px;padding:20px;background:rgba(255,255,255,0.05);border-radius:8px">
          <p style="margin:0 0 12px;color:var(--muted)">Ap√≥s finalizar o pedido, voc√™ receber√° um c√≥digo PIX para pagamento.</p>
          <div style="font-size:13px;color:var(--muted)">
            ‚úì Pagamento instant√¢neo<br>
            ‚úì Confirma√ß√£o em at√© 1 minuto<br>
            ‚úì V√°lido por 24 horas
          </div>
        </div>

        <!-- Informa√ß√µes Boleto (oculto por padr√£o) -->
        <div id="boleto-info" style="display:none;margin-bottom:20px;padding:20px;background:rgba(255,255,255,0.05);border-radius:8px">
          <p style="margin:0 0 12px;color:var(--muted)">Ap√≥s finalizar o pedido, voc√™ receber√° o boleto para pagamento.</p>
          <div style="font-size:13px;color:var(--muted)">
            ‚úì V√°lido por 3 dias √∫teis<br>
            ‚úì Confirma√ß√£o em 1-2 dias √∫teis<br>
            ‚úì Sem juros
          </div>
        </div>

        <!-- Endere√ßo de Entrega -->
        <div style="margin-bottom:20px;border-top:1px solid rgba(255,255,255,0.1);padding-top:20px">
          <h3 style="margin:0 0 12px">Endere√ßo de Entrega</h3>
          <div style="margin-bottom:12px;">
            <label for="cep">CEP</label><br>
            <input type="text" id="cep" name="cep" placeholder="00000-000" maxlength="9" style="width:100%; padding:10px; border-radius:8px; border:0;background:#0b1020;color:#e6eef8">
          </div>
          <div style="margin-bottom:12px;">
            <label for="address">Endere√ßo completo</label><br>
            <textarea id="address" name="address" placeholder="Rua, N√∫mero, Complemento, Bairro, Cidade - Estado" rows="3" style="width:100%; padding:10px; border-radius:8px; border:0;background:#0b1020;color:#e6eef8;resize:vertical"></textarea>
          </div>
        </div>

        <button type="submit" class="cta" style="width:100%;">Finalizar Compra</button>
      </form>
    </div>
  </div>
</main>

<footer style="margin-top:18px">
  <div class="container">
    <div class="footer-content">
      <div class="footer-left">
        <div style="font-weight:800">CiberTech</div>
        <div style="color:var(--muted)">¬© 2025 ‚Ä¢ Todos os direitos reservados</div>
      </div>
      <div class="footer-right" style="color:var(--muted)">
        Pagamento seguro ‚Ä¢ Parcelamos em at√© 12x
        <a href="registrar_produto.html" style="margin-left:12px; color:var(--primary); text-decoration:none; font-weight:600;">
          Registrar produto
        </a>
      </div>
    </div>
  </div>
</footer>

<script src="js/header.js"></script>
<script>
  // Controla exibi√ß√£o dos campos conforme m√©todo de pagamento
  function setupPaymentMethodToggle() {
    const radioButtons = document.querySelectorAll('input[name="payment_method"]');
    const cardFields = document.getElementById('card-fields');
    const pixInfo = document.getElementById('pix-info');
    const boletoInfo = document.getElementById('boleto-info');
    const installmentsDiv = document.querySelector('[style*="margin-bottom:12px"]:has(#installments)');

    radioButtons.forEach(radio => {
      radio.addEventListener('change', (e) => {
        const method = e.target.value;
        
        // Esconde todos primeiro
        if (cardFields) cardFields.style.display = 'none';
        if (pixInfo) pixInfo.style.display = 'none';
        if (boletoInfo) boletoInfo.style.display = 'none';
        if (installmentsDiv) installmentsDiv.style.display = 'none';

        // Mostra conforme sele√ß√£o
        if (method === 'credit_card') {
          if (cardFields) cardFields.style.display = 'block';
          if (installmentsDiv) installmentsDiv.style.display = 'block';
        } else if (method === 'debit_card') {
          if (cardFields) cardFields.style.display = 'block';
        } else if (method === 'pix') {
          if (pixInfo) pixInfo.style.display = 'block';
        } else if (method === 'boleto') {
          if (boletoInfo) boletoInfo.style.display = 'block';
        }
      });
    });

    // Define estado inicial (cart√£o de cr√©dito selecionado)
    const creditCardRadio = document.querySelector('input[value="credit_card"]');
    if (creditCardRadio && creditCardRadio.checked) {
      if (cardFields) cardFields.style.display = 'block';
      if (installmentsDiv) installmentsDiv.style.display = 'block';
    }
  }

  // Formata n√∫mero do cart√£o
  function formatCardNumber(input) {
    let value = input.value.replace(/\s/g, '').replace(/\D/g, '');
    let formatted = value.match(/.{1,4}/g)?.join(' ') || value;
    input.value = formatted;
  }

  // Carrega resumo do carrinho
  async function loadCartSummary() {
    try {
      const res = await fetch('php/cart.php');
      const data = await res.json();

      if (!data.success || !data.items || data.items.length === 0) {
        alert('Seu carrinho est√° vazio!');
        window.location.href = 'index.html';
        return;
      }

      const summaryList = document.querySelector('.sidebar ul');
      if (!summaryList) return;

      const FRETE = 49.90;
      const total = data.total + FRETE;

      summaryList.innerHTML = data.items.map(item => `
        <li style="display:flex; justify-content:space-between; margin-bottom:8px;">
          <span>${item.nome}</span> 
          <span>R$ ${parseFloat(item.preco * item.quantidade).toFixed(2).replace('.', ',')}</span>
        </li>
      `).join('') + `
        <li style="display:flex; justify-content:space-between; margin-bottom:8px; color:var(--muted)">
          <span>Frete</span> <span>R$ ${FRETE.toFixed(2).replace('.', ',')}</span>
        </li>
        <li style="display:flex; justify-content:space-between; font-weight:800; margin-top:12px;">
          <span>Total</span> <span>R$ ${total.toFixed(2).replace('.', ',')}</span>
        </li>
      `;

    } catch (err) {
      console.error('Erro ao carregar carrinho:', err);
    }
  }

  // Processa o checkout
  async function processCheckout(e) {
    e.preventDefault();
    
    const form = e.target;
    const submitBtn = form.querySelector('button[type="submit"]');
    
    if (!submitBtn) return;
    
    submitBtn.disabled = true;
    submitBtn.textContent = 'Processando...';

    try {
      const paymentMethod = form.payment_method?.value || 'credit_card';
      
      // Mapeia os valores do formul√°rio para os valores esperados pelo PHP
      const paymentMethodMap = {
        'credit_card': 'credito',
        'debit_card': 'debito',
        'pix': 'pix',
        'boleto': 'boleto'
      };
      
      const formData = {
        endereco_entrega: form.address?.value || '',
        cep: form.cep?.value || '',
        forma_pagamento: paymentMethodMap[paymentMethod] || 'credito',
        parcelas: paymentMethod === 'credit_card' ? (form.installments?.value || '1') : '1',
        frete: 49.90
      };

      const res = await fetch('php/checkout.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(formData)
      });

      const data = await res.json();

      if (!data.success) {
        alert(data.error || 'Erro ao processar pedido');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Finalizar Compra';
        return;
      }

      alert('Pedido realizado com sucesso! N√∫mero do pedido: ' + data.pedido_id);
      window.location.href = 'pedidos.html';

    } catch (err) {
      console.error('Erro no checkout:', err);
      alert('Erro ao processar pedido. Tente novamente.');
      submitBtn.disabled = false;
      submitBtn.textContent = 'Finalizar Compra';
    }
  }

  // Adiciona formata√ß√£o ao n√∫mero do cart√£o
  const cardNumberInput = document.getElementById('card-number');
  if (cardNumberInput) {
    cardNumberInput.addEventListener('input', (e) => formatCardNumber(e.target));
  }

  // Adiciona handler ao formul√°rio
  const checkoutForm = document.querySelector('form');
  if (checkoutForm) {
    checkoutForm.addEventListener('submit', processCheckout);
  }

  // Inicializa ao carregar
  document.addEventListener('DOMContentLoaded', () => {
    setupPaymentMethodToggle();
    loadCartSummary();
  });
</script>

</body>
</html>

